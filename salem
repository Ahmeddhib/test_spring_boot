pipeline {
    agent any

    environment {
        // â­ CORRECTION: Utilisez votre vrai repository Docker Hub
        DOCKER_IMAGE = "ahmedwolf/spring-test1"
        DOCKER_TAG = "latest"
    }

    stages {
        // ===== STAGE 1: CHECKOUT =====
        stage('Checkout') {
            steps {
                echo "ğŸ“¥ CHECKOUT CODE"
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Ahmeddhib/StudentsManagement-DevOps.git',
                        credentialsId: 'github-credentials'  // â­ AJOUTER CREDENTIALS
                    ]],
                    extensions: [[$class: 'CloneOption', shallow: true, depth: 1]]
                ])
                
                sh '''
                    echo "âœ… Code rÃ©cupÃ©rÃ©"
                    ls -la
                    echo ""
                    echo "ğŸ” VÃ©rification Dockerfile:"
                    if [ -f "Dockerfile" ]; then
                        echo "âœ… Dockerfile trouvÃ©"
                        cat Dockerfile
                    else
                        echo "âŒ Dockerfile non trouvÃ©!"
                        exit 1
                    fi
                '''
            }
        }

        // ===== STAGE 2: VÃ‰RIFICATION DOCKER =====
        stage('VÃ©rification Docker') {
            steps {
                script {
                    echo "ğŸ” VÃ‰RIFICATION DOCKER"
                    
                    // Test 1: Docker est-il installÃ©?
                    sh '''
                        echo "=== DOCKER VERSION ==="
                        docker --version || echo "âŒ Docker non installÃ©"
                    '''
                    
                    // Test 2: L'image existe-t-elle dÃ©jÃ ?
                    try {
                        sh "docker image inspect ${env.DOCKER_IMAGE}:${env.DOCKER_TAG} > /dev/null 2>&1"
                        echo "âœ… Image Docker existe dÃ©jÃ "
                        env.BUILD_NEEDED = "false"
                    } catch (Exception e) {
                        echo "â„¹ï¸ Image Docker n'existe pas, besoin de build"
                        env.BUILD_NEEDED = "true"
                    }
                    
                    echo "Build nÃ©cessaire? ${env.BUILD_NEEDED}"
                }
            }
        }

        // ===== STAGE 3: BUILD MAVEN =====
        stage('Build Maven') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                echo "ğŸ”¨ BUILD MAVEN"
                
                sh '''
                    echo "ğŸ§¹ Nettoyage..."
                    mvn clean || echo "Clean Ã©chouÃ©, continuation..."
                    
                    echo "ğŸ“¦ Packaging..."
                    mvn package -DskipTests -B
                    
                    echo "âœ… JAR crÃ©Ã©:"
                    ls -lh target/*.jar
                '''
            }
        }

        // ===== STAGE 4: BUILD DOCKER =====
        stage('Build Docker Image') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                echo "ğŸ³ BUILD DOCKER IMAGE"
                
                script {
                    // D'abord, tÃ©lÃ©charger les images de base
                    sh '''
                        echo "ğŸ“¥ TÃ©lÃ©chargement des images de base..."
                        docker pull maven:3.8.6-amazoncorretto-17 || true
                        docker pull amazoncorretto:17-alpine || true
                    '''
                    
                    // Ensuite builder
                    sh """
                        echo "ğŸ”¨ Construction de l'image Docker..."
                        docker build \\
                            --no-cache \\
                            -t ${env.DOCKER_IMAGE}:${env.DOCKER_TAG} \\
                            .
                        
                        echo "âœ… Image construite:"
                        docker images | grep ${env.DOCKER_IMAGE}
                    """
                }
            }
        }

        // ===== STAGE 5: PUSH DOCKER =====
        stage('Push Docker Image') {
            steps {
                echo "ğŸ“¤ PUSH TO DOCKER HUB"
                
                script {
                    // â­ CORRECTION: Utilisez le bon ID de credentials
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub-credentials',  // â­ CORRIGER ICI
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "ğŸ” Authentification Docker Hub..."
                            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                            
                            echo "ğŸ“¤ Pushing image..."
                            docker push ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}
                            
                            echo "âœ… Image poussÃ©e avec succÃ¨s!"
                            echo "ğŸ”— https://hub.docker.com/r/${env.DOCKER_IMAGE}"
                        """
                    }
                }
            }
        }
        
        // ===== STAGE 6: TEST DOCKER =====
        stage('Test Docker Image') {
            steps {
                echo "ğŸ§ª TEST DOCKER IMAGE"
                
                script {
                    sh """
                        echo "ğŸš€ Lancement du conteneur de test..."
                        
                        # Lancer un conteneur temporaire
                        docker run --rm \\
                            ${env.DOCKER_IMAGE}:${env.DOCKER_TAG} \\
                            java -version
                        
                        echo "âœ… Image Docker fonctionnelle!"
                    """
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ§¹ NETTOYAGE"
            sh '''
                echo "Nettoyage des images intermÃ©diaires..."
                docker images -f "dangling=true" -q | xargs -r docker rmi 2>/dev/null || true
            '''
            
            echo "ğŸ“Š RÃ‰SUMÃ‰ DU BUILD"
            echo "Image: ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
            echo "Statut: ${currentBuild.currentResult}"
        }
        
        success {
            echo "ğŸ‰ PIPELINE RÃ‰USSIE!"
        }
        
        failure {
            echo "âŒ PIPELINE Ã‰CHOUÃ‰E"
            echo "Consultez les logs pour les erreurs"
        }
    }
}
