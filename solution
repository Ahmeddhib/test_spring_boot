Solution Définitive : Installation Complète avec Script
Étape 1 : Nettoyage complet
bash
# Arrêter tous les services
sudo systemctl stop kubelet
sudo systemctl stop docker
sudo systemctl stop containerd

# Désinstaller tout
sudo apt remove --purge kubelet kubeadm kubectl docker.io containerd -y
sudo apt autoremove -y

# Nettoyer les fichiers
sudo rm -rf /etc/kubernetes
sudo rm -rf ~/.kube
sudo rm -rf /var/lib/etcd
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd

# Nettoyer iptables
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X
Étape 2 : Installation avec le script officiel Kubernetes
bash
# Télécharger et exécuter le script d'installation
curl -fsSL https://get.k8s.io | bash

# OU installer spécifiquement
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubeadm"
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubelet"

# Rendre exécutable
chmod +x kubectl kubeadm kubelet

# Déplacer
sudo mv kubectl kubeadm kubelet /usr/local/bin/
Étape 3 : Installer containerd (CRI recommandé)
bash
# Installer containerd
sudo apt update
sudo apt install -y containerd

# Créer la configuration
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml

# Modifier la configuration pour systemd cgroups
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

# Redémarrer containerd
sudo systemctl restart containerd
sudo systemctl enable containerd

# Vérifier que containerd fonctionne
sudo systemctl status containerd
sudo ctr version
Étape 4 : Configurer les modules kernel
bash
# Charger les modules nécessaires
sudo modprobe overlay
sudo modprobe br_netfilter

# Rendre permanent
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

# Configurer sysctl
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# Appliquer
sudo sysctl --system
Étape 5 : Désactiver swap
bash
# Désactiver immédiatement
sudo swapoff -a

# Désactiver définitivement
sudo sed -i '/swap/d' /etc/fstab

# Vérifier
free -h
Étape 6 : Initialiser kubeadm avec configuration spécifique
bash
# Créer un fichier de configuration pour kubeadm
cat <<EOF | sudo tee kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
nodeRegistration:
  criSocket: "unix:///var/run/containerd/containerd.sock"
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: 1.30.0
networking:
  podSubnet: "192.168.0.0/16"
EOF

# Initialiser avec le fichier de configuration
sudo kubeadm init --config=kubeadm-config.yaml
Étape 7 : Si toujours erreur CRI, forcer l'initialisation
bash
# Essayer cette commande qui ignore toutes les vérifications préliminaires
sudo kubeadm init \
  --pod-network-cidr=192.168.0.0/16 \
  --ignore-preflight-errors=all \
  --cri-socket=unix:///var/run/containerd/containerd.sock \
  --v=5
Étape 8 : Configuration après succès
bash
# Si kubeadm init réussit, configurer kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Installer Calico (réseau pod)
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml

# OU Flannel (plus simple)
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# Autoriser les pods sur le master (single node)
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
Solution Alternative : Utiliser Minikube (Beaucoup Plus Simple)
Si vous continuez à avoir des problèmes, je vous recommande d'utiliser Minikube pour votre démonstration :

bash
# Désinstaller tout d'abord
sudo kubeadm reset -f
sudo apt remove --purge kubelet kubeadm kubectl -y

# Installer Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# Installer les dépendances
sudo apt install -y conntrack

# Démarrer Minikube
minikube start --driver=docker

# Configurer kubectl
minikube kubectl -- get pods -A

# Créer un alias pour kubectl
alias kubectl="minikube kubectl --"

# Vérifier
kubectl get nodes
kubectl cluster-info
Vérification des problèmes courants
Si rien ne fonctionne, exécutez ces commandes de diagnostic :

bash
# 1. Vérifier les sockets CRI
ls -la /var/run/ | grep -E "\.sock"

# 2. Vérifier les services
sudo systemctl status containerd
sudo systemctl status docker

# 3. Vérifier les logs containerd
sudo journalctl -u containerd -f

# 4. Vérifier si containerd écoute
sudo netstat -lnp | grep containerd

# 5. Tester containerd manuellement
sudo ctr images pull docker.io/library/nginx:latest
sudo ctr images ls
Script Automatique Complet
Créez un fichier install-k8s.sh :

bash
#!/bin/bash

# Nettoyage
sudo kubeadm reset -f
sudo apt remove --purge kubelet kubeadm kubectl docker.io containerd -y
sudo apt autoremove -y

# Installation
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl

# Docker
sudo apt install -y docker.io
sudo systemctl enable docker
sudo systemctl start docker

# Containerd
sudo apt install -y containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

# Kubernetes
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

# Swap
sudo swapoff -a
sudo sed -i '/swap/d' /etc/fstab

# Initialisation FORCÉE
sudo kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=all

# Configuration
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Réseau
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# Single node
kubectl taint nodes --all node-role.kubernetes.io/control-plane-

echo "Installation terminée!"
Exécutez-le :

bash
chmod +x install-k8s.sh
sudo ./install-k8s.sh
