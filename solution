Solution D√©finitive : Installation Compl√®te avec Script
√âtape 1 : Nettoyage complet
bash
# Arr√™ter tous les services
sudo systemctl stop kubelet
sudo systemctl stop docker
sudo systemctl stop containerd

# D√©sinstaller tout
sudo apt remove --purge kubelet kubeadm kubectl docker.io containerd -y
sudo apt autoremove -y

# Nettoyer les fichiers
sudo rm -rf /etc/kubernetes
sudo rm -rf ~/.kube
sudo rm -rf /var/lib/etcd
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd

# Nettoyer iptables
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X
√âtape 2 : Installation avec le script officiel Kubernetes
bash
# T√©l√©charger et ex√©cuter le script d'installation
curl -fsSL https://get.k8s.io | bash

# OU installer sp√©cifiquement
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubeadm"
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubelet"

# Rendre ex√©cutable
chmod +x kubectl kubeadm kubelet

# D√©placer
sudo mv kubectl kubeadm kubelet /usr/local/bin/
√âtape 3 : Installer containerd (CRI recommand√©)
bash
# Installer containerd
sudo apt update
sudo apt install -y containerd

# Cr√©er la configuration
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml

# Modifier la configuration pour systemd cgroups
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

# Red√©marrer containerd
sudo systemctl restart containerd
sudo systemctl enable containerd

# V√©rifier que containerd fonctionne
sudo systemctl status containerd
sudo ctr version
√âtape 4 : Configurer les modules kernel
bash
# Charger les modules n√©cessaires
sudo modprobe overlay
sudo modprobe br_netfilter

# Rendre permanent
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

# Configurer sysctl
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# Appliquer
sudo sysctl --system
√âtape 5 : D√©sactiver swap
bash
# D√©sactiver imm√©diatement
sudo swapoff -a

# D√©sactiver d√©finitivement
sudo sed -i '/swap/d' /etc/fstab

# V√©rifier
free -h
√âtape 6 : Initialiser kubeadm avec configuration sp√©cifique
bash
# Cr√©er un fichier de configuration pour kubeadm
cat <<EOF | sudo tee kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
nodeRegistration:
  criSocket: "unix:///var/run/containerd/containerd.sock"
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: 1.30.0
networking:
  podSubnet: "192.168.0.0/16"
EOF

# Initialiser avec le fichier de configuration
sudo kubeadm init --config=kubeadm-config.yaml
√âtape 7 : Si toujours erreur CRI, forcer l'initialisation
bash
# Essayer cette commande qui ignore toutes les v√©rifications pr√©liminaires
sudo kubeadm init \
  --pod-network-cidr=192.168.0.0/16 \
  --ignore-preflight-errors=all \
  --cri-socket=unix:///var/run/containerd/containerd.sock \
  --v=5
√âtape 8 : Configuration apr√®s succ√®s
bash
# Si kubeadm init r√©ussit, configurer kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Installer Calico (r√©seau pod)
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml

# OU Flannel (plus simple)
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# Autoriser les pods sur le master (single node)
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
Solution Alternative : Utiliser Minikube (Beaucoup Plus Simple)
Si vous continuez √† avoir des probl√®mes, je vous recommande d'utiliser Minikube pour votre d√©monstration :

bash
# D√©sinstaller tout d'abord
sudo kubeadm reset -f
sudo apt remove --purge kubelet kubeadm kubectl -y

# Installer Minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# Installer les d√©pendances
sudo apt install -y conntrack

# D√©marrer Minikube
minikube start --driver=docker

# Configurer kubectl
minikube kubectl -- get pods -A

# Cr√©er un alias pour kubectl
alias kubectl="minikube kubectl --"

# V√©rifier
kubectl get nodes
kubectl cluster-info
V√©rification des probl√®mes courants
Si rien ne fonctionne, ex√©cutez ces commandes de diagnostic :

bash
# 1. V√©rifier les sockets CRI
ls -la /var/run/ | grep -E "\.sock"

# 2. V√©rifier les services
sudo systemctl status containerd
sudo systemctl status docker

# 3. V√©rifier les logs containerd
sudo journalctl -u containerd -f

# 4. V√©rifier si containerd √©coute
sudo netstat -lnp | grep containerd

# 5. Tester containerd manuellement
sudo ctr images pull docker.io/library/nginx:latest
sudo ctr images ls
Script Automatique Complet
Cr√©ez un fichier install-k8s.sh :

bash
#!/bin/bash

# Nettoyage
sudo kubeadm reset -f
sudo apt remove --purge kubelet kubeadm kubectl docker.io containerd -y
sudo apt autoremove -y

# Installation
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl

# Docker
sudo apt install -y docker.io
sudo systemctl enable docker
sudo systemctl start docker

# Containerd
sudo apt install -y containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

# Kubernetes
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

# Swap
sudo swapoff -a
sudo sed -i '/swap/d' /etc/fstab

# Initialisation FORC√âE
sudo kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=all

# Configuration
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# R√©seau
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# Single node
kubectl taint nodes --all node-role.kubernetes.io/control-plane-

echo "Installation termin√©e!"
Ex√©cutez-le :

bash
chmod +x install-k8s.sh
sudo ./install-k8s.sh
*******************************************************************************************

üñ•Ô∏è √âtape 1 : Pr√©parer les Machines Ubuntu
1.1 Configuration des machines (3 machines minimum)
bash
# Machine 1 : Master (2GB RAM minimum, 2 CPUs)
# Machine 2 : Worker 1 (1GB RAM minimum, 1 CPU)
# Machine 3 : Worker 2 (1GB RAM minimum, 1 CPU)

# Sur CHAQUE machine, ex√©cuter :
sudo hostnamectl set-hostname master  # Sur master
sudo hostnamectl set-hostname worker1 # Sur worker1
sudo hostnamectl set-hostname worker2 # Sur worker2

# Ajouter les hosts dans /etc/hosts sur CHAQUE machine
sudo tee -a /etc/hosts <<EOF
192.168.1.100 master
192.168.1.101 worker1
192.168.1.102 worker2
EOF

# Remplacer les IP par vos adresses r√©elles
1.2 Mise √† jour et installation des pr√©requis
bash
# Sur CHAQUE machine
sudo apt update
sudo apt upgrade -y

# Installer les outils n√©cessaires
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
üê≥ √âtape 2 : Installer containerd (Runtime de conteneurs)
2.1 Installer containerd
bash
# Sur CHAQUE machine
sudo apt install -y containerd

# Configurer containerd
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml

# Modifier la configuration pour utiliser systemd cgroup
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

# Red√©marrer containerd
sudo systemctl restart containerd
sudo systemctl enable containerd

# V√©rifier
sudo systemctl status containerd
2.2 Configuration des modules kernel
bash
# Sur CHAQUE machine
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# Configuration sysctl
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
2.3 D√©sactiver swap
bash
# Sur CHAQUE machine
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

# V√©rifier
free -h
‚öôÔ∏è √âtape 3 : Installer kubeadm, kubelet et kubectl
3.1 Ajouter le repository Kubernetes
bash
# Sur CHAQUE machine
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt update
3.2 Installer les packages
bash
# Sur CHAQUE machine
sudo apt install -y kubelet kubeadm kubectl

# Bloquer les mises √† jour automatiques
sudo apt-mark hold kubelet kubeadm kubectl

# V√©rifier les versions
kubeadm version
kubectl version --client
üëë √âtape 4 : Initialiser le n≈ìud ma√Ætre
4.1 Initialiser le cluster sur le master
bash
# SEULEMENT sur le master
sudo kubeadm init \
  --pod-network-cidr=10.244.0.0/16 \
  --apiserver-advertise-address=192.168.1.100 \
  --control-plane-endpoint=192.168.1.100

# Notez la commande kubeadm join qui s'affiche √† la fin
# Elle ressemble √† :
# kubeadm join 192.168.1.100:6443 --token abcdef.1234567890abcdef \
#   --discovery-token-ca-cert-hash sha256:...
4.2 Configurer kubectl sur le master
bash
# SEULEMENT sur le master
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Tester
kubectl get nodes
üåê √âtape 5 : Installer un plugin r√©seau (CNI)
5.1 Installer Flannel (recommand√© pour les d√©butants)
bash
# SEULEMENT sur le master
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# OU installer Calico (plus avanc√©)
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
5.2 V√©rifier l'installation du CNI
bash
# Attendre quelques minutes puis v√©rifier
kubectl get pods --all-namespaces
kubectl get nodes
üîÑ √âtape 6 : Joindre les workers au cluster
6.1 G√©n√©rer un nouveau token (si n√©cessaire)
bash
# Sur le master, si le token a expir√©
kubeadm token create --print-join-command
6.2 Joindre les workers
bash
# Sur CHAQUE worker, ex√©cuter la commande join
# (La commande affich√©e √† l'√©tape 4.1)

# Exemple :
sudo kubeadm join 192.168.1.100:6443 \
  --token abcdef.1234567890abcdef \
  --discovery-token-ca-cert-hash sha256:...

# Si vous avez perdu la commande, sur le master :
kubeadm token create --print-join-command
6.3 V√©rifier que les nodes ont rejoint
bash
# Sur le master
kubectl get nodes

# Doit afficher quelque chose comme :
# NAME     STATUS   ROLES           AGE   VERSION
# master   Ready    control-plane   10m   v1.30.0
# worker1  Ready    <none>          5m    v1.30.0
# worker2  Ready    <none>          5m    v1.30.0
‚úÖ √âtape 7 : V√©rification du cluster
7.1 Tests de base
bash
# Sur le master
# V√©rifier l'√©tat du cluster
kubectl cluster-info

# V√©rifier tous les composants syst√®me
kubectl get pods --all-namespaces

# V√©rifier les nodes avec plus de d√©tails
kubectl get nodes -o wide

# V√©rifier les services syst√®me
kubectl get svc -n kube-system
7.2 D√©ployer une application test
bash
# Cr√©er un namespace de test
kubectl create namespace test-app

# D√©ployer une application de test
kubectl create deployment nginx-test --image=nginx -n test-app

# Exposer le service
kubectl expose deployment nginx-test --port=80 --type=NodePort -n test-app

# V√©rifier
kubectl get all -n test-app
üîß √âtape 8 : Configuration avanc√©e (Optionnel)
8.1 Configurer l'autocompl√©tion pour kubectl
bash
# Sur le master et sur votre machine locale si vous acc√©dez √† distance
echo 'source <(kubectl completion bash)' >> ~/.bashrc
source ~/.bashrc
8.2 Installer le dashboard Kubernetes
bash
# Installer le dashboard
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

# Cr√©er un utilisateur admin
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
EOF

cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
EOF

# Obtenir le token
kubectl -n kubernetes-dashboard create token admin-user

# Acc√©der au dashboard
kubectl proxy
# Puis acc√©der √† : http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
8.3 Configurer l'acc√®s distant √† kubectl
bash
# Copier le fichier config vers votre machine locale
# Sur votre machine locale :
mkdir -p ~/.kube
scp utilisateur@master:/home/utilisateur/.kube/config ~/.kube/config

# Remplacer l'adresse IP si n√©cessaire
sed -i 's/192.168.1.100/<IP-PUBLIQUE-MASTER>/g' ~/.kube/config
üìä Tableau r√©capitulatif des commandes par r√¥le
R√¥le	Sur Master	Sur Workers
Pr√©paration	Toutes les √©tapes 1.x	Toutes les √©tapes 1.x
containerd	√âtapes 2.x	√âtapes 2.x
kubeadm	√âtapes 3.x	√âtapes 3.x
Initialisation	kubeadm init	-
Configuration	Configurer kubectl	-
CNI	Installer Flannel/Calico	-
Join	-	kubeadm join
V√©rification	kubectl get nodes	-
üö® D√©pannage des probl√®mes courants
Probl√®me : Les workers ne rejoignent pas
bash
# V√©rifier la connectivit√© r√©seau
ping 192.168.1.100  # Depuis les workers vers le master

# V√©rifier les ports ouverts sur le master
sudo netstat -tlnp | grep 6443

# Reg√©n√©rer un token
sudo kubeadm token create --print-join-command
Probl√®me : Les pods restent en "Pending"
bash
# V√©rifier les √©v√©nements
kubectl get events --sort-by='.lastTimestamp'

# V√©rifier les ressources disponibles
kubectl describe nodes

# V√©rifier le CNI
kubectl get pods -n kube-system | grep -E "flannel|calico"
Probl√®me : kubelet ne d√©marre pas
bash
# V√©rifier les logs
sudo journalctl -u kubelet -f

# R√©initialiser
sudo kubeadm reset
sudo systemctl restart kubelet
üìù Script d'automatisation complet
Script pour le Master :
bash
#!/bin/bash
# setup-master.sh

echo "=== Configuration du Master Kubernetes ==="

# 1. Mise √† jour
sudo apt update && sudo apt upgrade -y

# 2. Installer containerd
sudo apt install -y containerd
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

# 3. D√©sactiver swap
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

# 4. Installer kubeadm, kubelet, kubectl
sudo apt install -y apt-transport-https curl
curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

# 5. Initialiser le cluster
sudo kubeadm init \
  --pod-network-cidr=10.244.0.0/16 \
  --apiserver-advertise-address=$(hostname -I | awk '{print $1}')

# 6. Configurer kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 7. Installer Flannel
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

echo "=== Master configur√© ==="
echo "Commande pour joindre les workers:"
kubeadm token create --print-join-command
Script pour les Workers :
bash
#!/bin/bash
# setup-worker.sh
# Usage: ./setup-worker.sh <MASTER_IP> <JOIN_COMMAND>

MASTER_IP=$1
JOIN_CMD=$2

echo "=== Configuration du Worker Kubernetes ==="

# 1-4. M√™mes √©tapes que le master
# ... (copier les √©tapes 1-4 du script master)

# 5. Joindre le cluster
sudo $JOIN_CMD

echo "=== Worker configur√© et joint au cluster ==="
üéâ Votre cluster est maintenant op√©rationnel !
bash
# Pour v√©rifier que tout fonctionne :
kubectl get nodes -o wide
kubectl cluster-info
kubectl get pods --all-namespaces

# Pour d√©ployer votre application Spring Boot comme dans le TP pr√©c√©dent :
kubectl create namespace devops
# Suivre les m√™mes √©tapes YAML que pour Minikube
