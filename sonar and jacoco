Configuration SonarQube et Tests avec JaCoCo
Voici les √©tapes compl√®tes pour ajouter SonarQube et JaCoCo √† votre projet Jenkins.

√âtape 1 : Installer SonarQube
1.1. Installer SonarQube via Docker (recommand√©)
bash
# Cr√©er un volume pour les donn√©es
docker volume create sonarqube_data
docker volume create sonarqube_logs
docker volume create sonarqube_extensions

# Lancer SonarQube
docker run -d \
  --name sonarqube \
  -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -v sonarqube_data:/opt/sonarqube/data \
  -v sonarqube_logs:/opt/sonarqube/logs \
  -v sonarqube_extensions:/opt/sonarqube/extensions \
  sonarqube:lts-community

# V√©rifier que SonarQube tourne
docker logs sonarqube
curl http://localhost:9000
1.2. Configuration initiale de SonarQube
Ouvrir http://localhost:9000 (ou http://votre-ip:9000)

Connexion : admin/admin

Changer le mot de passe

Cr√©er un token :

Administration ‚Üí Security ‚Üí Users ‚Üí admin ‚Üí Tokens

G√©n√©rer un token : "jenkins-token"

Copier le token (vous en aurez besoin)

√âtape 2 : Configurer SonarQube dans Jenkins
2.1. Installer les plugins Jenkins
bash
# Red√©marrer Jenkins d'abord
sudo systemctl restart jenkins
Via l'interface Jenkins :

G√©rer Jenkins ‚Üí G√©rer les plugins

Rechercher et installer :

SonarQube Scanner for Jenkins

JaCoCo Plugin

Red√©marrer Jenkins

2.2. Configurer SonarQube Server dans Jenkins
G√©rer Jenkins ‚Üí Configure System

Section SonarQube servers :

‚úÖ Environment variables

Nom : sonar-server

URL : http://localhost:9000 (ou votre URL)

Token : Coller le token g√©n√©r√© pr√©c√©demment

2.3. Configurer SonarQube Scanner
G√©rer Jenkins ‚Üí Outils globaux

Section SonarQube Scanner :

‚úÖ SonarQube Scanner installations

Nom : sonar-scanner

Installation automatique : SonarScanner 5.0.1.3006

√âtape 3 : Configurer votre projet Maven
3.1. Ajouter JaCoCo et Sonar dans pom.xml
xml
<!-- Ajouter dans pom.xml -->
<properties>
    <sonar.host.url>http://localhost:9000</sonar.host.url>
    <sonar.login>${env.SONAR_TOKEN}</sonar.login>
    <jacoco.version>0.8.12</jacoco.version>
</properties>

<dependencies>
    <!-- D√©pendances existantes... -->
</dependencies>

<build>
    <plugins>
        <!-- Plugin JaCoCo pour la couverture de code -->
        <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>${jacoco.version}</version>
            <executions>
                <execution>
                    <id>prepare-agent</id>
                    <goals>
                        <goal>prepare-agent</goal>
                    </goals>
                </execution>
                <execution>
                    <id>report</id>
                    <phase>verify</phase>
                    <goals>
                        <goal>report</goal>
                    </goals>
                </execution>
                <execution>
                    <id>jacoco-check</id>
                    <goals>
                        <goal>check</goal>
                    </goals>
                    <configuration>
                        <rules>
                            <rule>
                                <element>CLASS</element>
                                <limits>
                                    <limit>
                                        <counter>LINE</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.80</minimum> <!-- 80% de couverture minimum -->
                                    </limit>
                                </limits>
                            </rule>
                        </rules>
                    </configuration>
                </execution>
            </executions>
        </plugin>

        <!-- Plugin SonarQube -->
        <plugin>
            <groupId>org.sonarsource.scanner.maven</groupId>
            <artifactId>sonar-maven-plugin</artifactId>
            <version>3.11.0.3922</version>
        </plugin>

        <!-- Plugin Surefire pour ex√©cuter les tests -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <version>3.5.0</version>
            <configuration>
                <includes>
                    <include>**/*Test.java</include>
                    <include>**/*Tests.java</include>
                </includes>
                <excludes>
                    <exclude>**/*IntegrationTest.java</exclude>
                </excludes>
            </configuration>
        </plugin>
    </plugins>
</build>

<profiles>
    <profile>
        <id>sonar</id>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
        <properties>
            <sonar.java.coveragePlugin>jacoco</sonar.java.coveragePlugin>
            <sonar.dynamicAnalysis>reuseReports</sonar.dynamicAnalysis>
            <sonar.jacoco.reportPath>${project.build.directory}/jacoco.exec</sonar.jacoco.reportPath>
            <sonar.language>java</sonar.language>
            <sonar.sourceEncoding>UTF-8</sonar.sourceEncoding>
            <sonar.coverage.jacoco.xmlReportPaths>${project.build.directory}/site/jacoco/jacoco.xml</sonar.coverage.jacoco.xmlReportPaths>
        </properties>
    </profile>
</profiles>
3.2. Cr√©er un fichier sonar-project.properties
properties
# sonar-project.properties
sonar.projectKey=student-management
sonar.projectName=Student Management System
sonar.projectVersion=1.0

sonar.sources=src/main/java
sonar.tests=src/test/java
sonar.java.binaries=target/classes
sonar.java.libraries=target/**/*.jar

sonar.coverage.exclusions=**/*Application.java,**/config/**/*,**/model/**/*,**/dto/**/*

sonar.junit.reportsPath=target/surefire-reports
sonar.jacoco.reportPath=target/jacoco.exec
sonar.java.coveragePlugin=jacoco
√âtape 4 : Modifier votre Jenkinsfile
groovy
pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "ahmedwolf/spring-test3"
        DOCKER_TAG = "build-${env.BUILD_NUMBER}"
        DOCKER_LATEST = "latest"
        
        // Variables SonarQube (ajouter dans Jenkins Credentials)
        SONAR_TOKEN = credentials('sonar-token')
        SONAR_HOST_URL = "http://localhost:9000"
    }

    tools {
        maven 'Maven-3.9.9'  // Configurer Maven dans Jenkins
        jdk 'jdk17'          // Configurer JDK dans Jenkins
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Check for Code Changes') {
            steps {
                script {
                    // Votre logique de d√©tection de changements existante
                    // ...
                    echo "Build n√©cessaire ? ${env.BUILD_NEEDED}"
                }
            }
        }

        stage('Build & Test') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                sh '''
                    echo "üî® Compilation et tests..."
                    mvn clean compile test-compile
                '''
            }
        }

        stage('Unit Tests & Coverage') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                sh '''
                    echo "üß™ Ex√©cution des tests unitaires..."
                    mvn test -DskipITs
                '''
                
                // Publier les r√©sultats des tests JUnit
                junit '**/target/surefire-reports/*.xml'
                
                // Publier le rapport JaCoCo
                jacoco(
                    execPattern: '**/target/jacoco.exec',
                    classPattern: '**/target/classes',
                    sourcePattern: '**/src/main/java',
                    exclusionPattern: '**/*Test*,**/*test*'
                )
            }
        }

        stage('SonarQube Analysis') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh '''
                        echo "üìä Analyse SonarQube..."
                        mvn sonar:sonar \
                            -Dsonar.projectKey=student-management \
                            -Dsonar.projectName="Student Management System" \
                            -Dsonar.host.url=${SONAR_HOST_URL} \
                            -Dsonar.login=${SONAR_TOKEN} \
                            -Dsonar.java.binaries=target/classes \
                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                            -Dsonar.junit.reportsPath=target/surefire-reports
                    '''
                }
            }
        }

        stage('Quality Gate') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Package') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                sh '''
                    echo "üì¶ Packaging..."
                    mvn package -DskipTests
                '''
            }
        }

        stage('Build Docker Image') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                script {
                    sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                    sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:${DOCKER_LATEST}"
                    echo "‚úÖ Image Docker construite : ${DOCKER_IMAGE}:${DOCKER_TAG}"
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub', 
                        usernameVariable: 'DOCKER_USER', 
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            echo "Authentification sur Docker Hub..."
                            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                            
                            echo "Images disponibles localement :"
                            docker images | grep ${DOCKER_IMAGE} || echo "Aucune image trouv√©e"
                            
                            if docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} > /dev/null 2>&1; then
                                echo "Push de l'image avec tag ${DOCKER_TAG}..."
                                docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                            else
                                echo "‚ö†Ô∏è Image ${DOCKER_IMAGE}:${DOCKER_TAG} non trouv√©e localement"
                            fi
                            
                            if [ "${BUILD_NEEDED}" = "true" ]; then
                                echo "Push de l'image avec tag latest..."
                                docker push ${DOCKER_IMAGE}:${DOCKER_LATEST}
                            fi
                        '''
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    sh '''
                        echo "üîÑ D√©ploiement sur Kubernetes..."
                        
                        if docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} > /dev/null 2>&1; then
                            IMAGE_TO_DEPLOY="${DOCKER_IMAGE}:${DOCKER_TAG}"
                        else
                            IMAGE_TO_DEPLOY="${DOCKER_IMAGE}:${DOCKER_LATEST}"
                        fi
                        
                        echo "Image √† d√©ployer: \${IMAGE_TO_DEPLOY}"
                        
                        kubectl set image deployment/spring-test3 \
                            spring-test3=\${IMAGE_TO_DEPLOY} --record
                        
                        kubectl rollout status deployment/spring-test3 --timeout=300s
                        
                        echo "‚úÖ D√©ploiement Kubernetes termin√©"
                        
                        kubectl get deployment spring-test3 -o wide
                    '''
                }
            }
        }

        stage('Integration Tests') {
            when {
                expression { env.BUILD_NEEDED == "true" }
            }
            steps {
                script {
                    // Attendre que l'application soit pr√™te
                    sleep 30
                    
                    sh '''
                        echo "üîó Tests d'int√©gration..."
                        
                        # R√©cup√©rer l'URL du service
                        SERVICE_URL=$(kubectl get service spring-test3 -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                        if [ -z "$SERVICE_URL" ]; then
                            # Si pas d'IP externe, utiliser port-forward
                            kubectl port-forward service/spring-test3 8080:8080 &
                            PF_PID=$!
                            SERVICE_URL="http://localhost:8080"
                            sleep 5
                        fi
                        
                        echo "Testing service at: $SERVICE_URL"
                        
                        # Tests API
                        curl -f $SERVICE_URL/actuator/health || echo "Health check failed"
                        curl -f $SERVICE_URL/api/students || echo "Students endpoint failed"
                        
                        # Tuer le port-forward si utilis√©
                        kill $PF_PID 2>/dev/null || true
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Nettoyage..."
            sh '''
                docker logout || true
                # Nettoyer les conteneurs et images
                docker system prune -f || true
            '''
            
            // Rapports de qualit√©
            recordIssues(
                tools: [
                    java(), 
                    mavenConsole(),
                    junitParser(pattern: '**/target/surefire-reports/*.xml')
                ]
            )
        }
        
        success {
            echo "‚úÖ Pipeline termin√©e avec succ√®s !"
            
            // Notification si qualit√© OK
            script {
                if (env.BUILD_NEEDED == "true") {
                    echo "üìà Rapport SonarQube disponible sur: ${SONAR_HOST_URL}/dashboard?id=student-management"
                    echo "üìä Couverture de code JaCoCo disponible dans l'interface Jenkins"
                }
            }
        }
        
        failure {
            echo "‚ùå Pipeline √©chou√©e !"
            // Logs d'erreur
            sh '''
                echo "=== Derniers logs Kubernetes ==="
                kubectl logs deployment/spring-test3 --tail=50 || true
                
                echo "=== Statut des pods ==="
                kubectl get pods || true
                
                echo "=== √âv√©nements ==="
                kubectl get events --sort-by='.lastTimestamp' || true
            '''
        }
        
        unstable {
            echo "‚ö†Ô∏è Pipeline instable (tests √©chou√©s ou qualit√© insuffisante)"
        }
    }
}
√âtape 5 : Configurer les Quality Gates dans SonarQube
Acc√©der √† SonarQube : http://localhost:9000

Cr√©er un projet :

Administration ‚Üí Projects ‚Üí Create Project

Project Key : student-management

Display Name : Student Management System

Configurer Quality Gate :

Quality Gates ‚Üí Create

Nom : Jenkins Quality Gate

Conditions :

Coverage on New Code > 80%

Duplicated Lines on New Code < 3%

Maintainability Rating A

Reliability Rating A

Security Rating A

Appliquer au projet

√âtape 6 : Cr√©er des tests (exemples)
6.1. Test unitaire simple
java
// src/test/java/tn/esprit/StudentServiceTest.java
package tn.esprit;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

@ExtendWith(MockitoExtension.class)
public class StudentServiceTest {
    
    @Mock
    private StudentRepository studentRepository;
    
    @InjectMocks
    private StudentService studentService;
    
    @Test
    public void testGetAllStudents() {
        // Given
        when(studentRepository.findAll()).thenReturn(Arrays.asList(
            new Student(1L, "John", "Doe", "john@example.com"),
            new Student(2L, "Jane", "Smith", "jane@example.com")
        ));
        
        // When
        List<Student> students = studentService.getAllStudents();
        
        // Then
        assertEquals(2, students.size());
        verify(studentRepository, times(1)).findAll();
    }
    
    @Test
    public void testCreateStudent() {
        // Given
        Student student = new Student(null, "John", "Doe", "john@example.com");
        Student savedStudent = new Student(1L, "John", "Doe", "john@example.com");
        
        when(studentRepository.save(student)).thenReturn(savedStudent);
        
        // When
        Student result = studentService.createStudent(student);
        
        // Then
        assertNotNull(result.getId());
        assertEquals("John", result.getFirstName());
        verify(studentRepository, times(1)).save(student);
    }
}
6.2. Test d'int√©gration
java
// src/test/java/tn/esprit/StudentControllerIntegrationTest.java
package tn.esprit;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.web.servlet.MockMvc;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc
public class StudentControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    public void testGetAllStudents() throws Exception {
        mockMvc.perform(get("/api/students"))
               .andExpect(status().isOk())
               .andExpect(jsonPath("$").isArray());
    }
    
    @Test
    public void testCreateStudent() throws Exception {
        String studentJson = "{\"firstName\":\"John\",\"lastName\":\"Doe\",\"email\":\"john@example.com\"}";
        
        mockMvc.perform(post("/api/students")
                .contentType("application/json")
                .content(studentJson))
               .andExpect(status().isCreated())
               .andExpect(jsonPath("$.firstName").value("John"));
    }
}
√âtape 7 : Scripts utilitaires
7.1. V√©rification locale
bash
#!/bin/bash
# test-local.sh

echo "1. Ex√©cution des tests unitaires..."
mvn test

echo "2. G√©n√©ration du rapport de couverture..."
mvn jacoco:report

echo "3. Analyse SonarQube locale..."
mvn sonar:sonar \
  -Dsonar.projectKey=student-management \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.login=your-token-here

echo "4. Rapport disponible: target/site/jacoco/index.html"
7.2. Cleanup script
bash
#!/bin/bash
# cleanup.sh

echo "Nettoyage des donn√©es de test..."
docker stop sonarqube 2>/dev/null || true
docker rm sonarqube 2>/dev/null || true

echo "Suppression des rapports..."
rm -rf target/site target/surefire-reports target/jacoco.exec

echo "Nettoyage Kubernetes..."
kubectl delete deployment spring-test3 2>/dev/null || true
kubectl delete service spring-test3 2>/dev/null || true
R√©sum√© des b√©n√©fices :
‚úÖ Qualit√© du code : Analyse statique avec SonarQube

‚úÖ Couverture de tests : JaCoCo mesure le % de code test√©

‚úÖ Tests automatis√©s : JUnit pour tests unitaires et d'int√©gration

‚úÖ Quality Gate : Bloque le d√©ploiement si qualit√© insuffisante

‚úÖ Rapports d√©taill√©s : Interface web pour analyser les r√©sultats

Prochaines √©tapes :

Lancez SonarQube avec Docker

Configurez Jenkins avec le plugin SonarQube

Modifiez votre pom.xml avec les plugins JaCoCo/Sonar

Cr√©ez quelques tests pour votre application

Testez la nouvelle pipeline !

Cela donnera une qualit√© professionnelle √† votre pipeline CI/CD ! üöÄ

est ce que jacoco comme junit or no ??
Non, JaCoCo n'est pas comme JUnit ! Ce sont des outils compl√©mentaires mais avec des fonctions diff√©rentes.

Diff√©rence claire :
Outils	Fonction principale	Quand s'ex√©cute	R√©sultat produit
JUnit	Ex√©cute les tests	Pendant mvn test	Rapport XML (TEST-*.xml) - Quels tests passent/√©chouent
JaCoCo	Mesure la couverture	Pendant l'ex√©cution des tests	Rapport binaire (jacoco.exec) + HTML - Combien de code est test√©
SonarQube	Analyse la qualit√©	Apr√®s les tests	Dashboard web - Analyse compl√®te (bugs, vuln√©rabilit√©s, dette technique)
Analogie simple :
JUnit = Professeur qui corrige les copies (‚úì ou ‚úó)

JaCoCo = Compteur qui mesure combien de mati√®re a √©t√© couverte (%)

SonarQube = Inspecteur qui v√©rifie la qualit√© globale

Exemple concret :
java
// Classe √† tester
public class Calculator {
    public int add(int a, int b) {
        return a + b;  // Ligne 3
    }
    
    public int multiply(int a, int b) {
        return a * b;  // Ligne 7 (NON TEST√âE)
    }
}
Test JUnit :

java
@Test
public void testAdd() {
    Calculator calc = new Calculator();
    assertEquals(5, calc.add(2, 3));  // Teste seulement add()
}
R√©sultats :

Outil	R√©sultat	Interpr√©tation
JUnit	‚úÖ 1 test r√©ussi, 0 √©chou√©	"Les tests passent"
JaCoCo	üìä 50% de couverture (3/6 lignes)	"Seule la moiti√© du code est test√©e"
SonarQube	‚ö†Ô∏è "Couverture insuffisante"	"Am√©liorer les tests"
Dans votre pipeline :
groovy
stage('Tests') {
    steps {
        // 1. JUnit ex√©cute les tests
        sh 'mvn test'
        
        // 2. JUnit publie les r√©sultats (quels tests passent)
        junit '**/target/surefire-reports/*.xml'
        
        // 3. JaCoCo publie la couverture (% de code test√©)
        jacoco(
            execPattern: '**/target/jacoco.exec',
            classPattern: '**/target/classes'
        )
    }
}
Configuration Maven :
xml
<!-- pom.xml -->
<plugins>
    <!-- 1. JUnit s'ex√©cute via Surefire -->
    <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.5.0</version>
    </plugin>
    
    <!-- 2. JaCoCo instrumente le code pour mesurer la couverture -->
    <plugin>
        <groupId>org.jacoco</groupId>
        <artifactId>jacoco-maven-plugin</artifactId>
        <version>0.8.12</version>
        <executions>
            <execution>
                <id>prepare-agent</id>
                <goals>
                    <goal>prepare-agent</goal>  <!-- Instrumente le code -->
                </goals>
            </execution>
            <execution>
                <id>report</id>
                <phase>test</phase>
                <goals>
                    <goal>report</goal>  <!-- G√©n√®re le rapport HTML -->
                </goals>
            </execution>
        </executions>
    </plugin>
</plugins>
Workflow complet :
text
[Code Java]
     ‚Üì
[mvn test] ‚Üí JUnit ex√©cute les tests
     ‚Üì
JaCoCo instrumente ‚Üí mesure quelles lignes sont ex√©cut√©es
     ‚Üì
[jacoco.exec] ‚Üí fichier binaire de couverture
     ‚Üì
Rapport HTML ‚Üí target/site/jacoco/index.html
     ‚Üì
Jenkins Jacoco Plugin ‚Üí affiche dans Jenkins
     ‚Üì
SonarQube ‚Üí analyse la qualit√©
Visualisation dans Jenkins :
Apr√®s un build, vous verrez :

JUnit ‚Üí Onglet "Test Results" :

text
Tests: 15 passed, 2 failed, 17 total
JaCoCo ‚Üí Onglet "Coverage Report" :

text
Instructions: 85% covered
Branches: 72% covered
Lines: 89% covered
SonarQube ‚Üí Lien vers dashboard :

text
Quality Gate: PASSED
Bugs: 0
Vulnerabilities: 2
Coverage: 85%
Pour r√©sumer :
JUnit = QUELS tests passent/√©chouent

JaCoCo = COMBIEN de code est test√© (%)

SonarQube = QUALIT√â globale du code

Vous avez besoin des trois pour une pipeline CI/CD compl√®te :

JUnit pour v√©rifier la correction fonctionnelle

JaCoCo pour mesurer l'exhaustivit√© des tests

SonarQube pour assurer la qualit√©/maintenabilit√©

Conseil : Commencez par ajouter JaCoCo √† votre pom.xml, puis cr√©ez quelques tests JUnit pour voir la couverture augmenter !















1. V√©rifier et attendre le d√©marrage
bash
# Attendre quelques secondes (SonarQube prend 1-2 minutes pour d√©marrer)
sleep 60

# V√©rifier les logs r√©cents
docker logs sonarqube --tail 20

# V√©rifier si le conteneur tourne
docker ps | grep sonarqube

# V√©rifier si le port 9000 est en √©coute
sudo netstat -tlnp | grep 9000
2. V√©rifier la m√©moire disponible
bash
# SonarQube n√©cessite au moins 2GB de RAM
free -h

# V√©rifier la m√©moire utilis√©e par Docker
docker stats sonarqube --no-stream
3. Red√©marrer SonarQube avec plus de m√©moire
bash
# Arr√™ter et supprimer l'instance actuelle
docker stop sonarqube
docker rm sonarqube

# Red√©marrer avec plus de m√©moire (si disponible)
docker run -d \
  --name sonarqube \
  -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_WEB_JAVAOPTS="-Xmx1024m -Xms512m -XX:+UseG1GC" \
  -v sonarqube_data:/opt/sonarqube/data \
  -v sonarqube_logs:/opt/sonarqube/logs \
  -v sonarqube_extensions:/opt/sonarqube/extensions \
  sonarqube:lts-community
4. Version all√©g√©e pour machines avec peu de RAM
bash
# Utiliser la version Community LTS all√©g√©e
docker stop sonarqube 2>/dev/null || true
docker rm sonarqube 2>/dev/null || true

docker run -d \
  --name sonarqube \
  -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_WEB_JAVAOPTS="-Xmx512m -Xms256m" \
  -e SONAR_SEARCH_JAVAOPTS="-Xmx512m -Xms256m" \
  -e SONAR_CE_JAVAOPTS="-Xmx512m -Xms256m" \
  sonarqube:lts-community
5. Script de d√©marrage avec v√©rification
bash
#!/bin/bash
# start-sonarqube.sh

echo "üöÄ D√©marrage de SonarQube..."

# Arr√™ter si d√©j√† en cours
docker stop sonarqube 2>/dev/null || true
docker rm sonarqube 2>/dev/null || true

# Lancer SonarQube
docker run -d \
  --name sonarqube \
  -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_WEB_JAVAOPTS="-Xmx1024m -Xms512m" \
  -v sonarqube_data:/opt/sonarqube/data \
  -v sonarqube_logs:/opt/sonarqube/logs \
  -v sonarqube_extensions:/opt/sonarqube/extensions \
  sonarqube:lts-community

echo "‚è≥ Attente du d√©marrage de SonarQube (peut prendre 1-2 minutes)..."

# Attendre et v√©rifier
for i in {1..30}; do
    if curl -s http://localhost:9000 > /dev/null 2>&1; then
        echo "‚úÖ SonarQube d√©marr√© avec succ√®s!"
        echo "üåê Acc√©dez √†: http://localhost:9000"
        echo "üîë Identifiants par d√©faut: admin/admin"
        exit 0
    fi
    echo -n "."
    sleep 5
done

echo ""
echo "‚ùå SonarQube ne r√©pond pas apr√®s 150 secondes"
echo "üìã Affichage des logs..."

docker logs sonarqube --tail 50

echo ""
echo "üí° Solutions possibles:"
echo "1. Attendez encore quelques minutes"
echo "2. V√©rifiez la m√©moire disponible: free -h"
echo "3. Red√©marrez avec: docker restart sonarqube"
6. Solution alternative : Utiliser SonarQube en mode d√©veloppement
bash
# Mode d√©veloppement (d√©marrage plus rapide, moins de ressources)
docker run -d \
  --name sonarqube-dev \
  -p 9000:9000 \
  -e SONAR_WEB_JAVAOPTS="-Xmx512m -Xms256m" \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_FORCEAUTHENTICATION=false \
  sonarqube:community
7. V√©rification √©tape par √©tape
bash
# √âtape 1: V√©rifier le conteneur
docker ps -a | grep sonarqube

# √âtape 2: Voir les logs complets
docker logs sonarqube

# √âtape 3: V√©rifier les ressources
docker stats sonarqube

# √âtape 4: Acc√©der aux logs d'Elasticsearch
docker exec sonarqube cat /opt/sonarqube/logs/es.log

# √âtape 5: Red√©marrer si bloqu√©
docker restart sonarqube
8. Solution rapide (tous probl√®mes)
bash
# Nettoyer compl√®tement
docker stop sonarqube 2>/dev/null || true
docker rm sonarqube 2>/dev/null || true
docker volume rm sonarqube_data sonarqube_logs sonarqube_extensions 2>/dev/null || true

# Recr√©er les volumes
docker volume create sonarqube_data
docker volume create sonarqube_logs
docker volume create sonarqube_extensions

# D√©marrer avec configuration minimale
docker run -d \
  --name sonarqube \
  -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_WEB_JAVAOPTS="-Xmx512m -Xms256m" \
  sonarqube:lts-community

# Attendre et v√©rifier
echo "Attente du d√©marrage..."
sleep 120
curl -f http://localhost:9000 && echo "‚úÖ SonarQube pr√™t!" || echo "‚ùå Encore des probl√®mes"
9. Si vous avez peu de RAM sur la VM
bash
# 1. Augmenter la m√©moire de la VM (si VirtualBox)
#    - Arr√™ter la VM
#    - Settings ‚Üí System ‚Üí Motherboard ‚Üí Base Memory (4096 MB minimum)
#    - Settings ‚Üí System ‚Üí Processor ‚Üí Processors (2 minimum)

# 2. Utiliser une alternative l√©g√®re
docker run -d \
  --name sonarqube-light \
  -p 9000:9000 \
  -e SONAR_FORCEAUTHENTICATION=false \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_WEB_JAVAOPTS="-Xmx256m -Xms128m" \
  sonarqube:9.9.1-community
10. Commande de test finale
bash
# Ex√©cutez cette commande compl√®te
docker stop sonarqube 2>/dev/null; docker rm sonarqube 2>/dev/null; \
docker run -d --name sonarqube -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  -e SONAR_WEB_JAVAOPTS="-Xmx512m -Xms256m" \
  sonarqube:lts-community && \
echo "Attente 90 secondes..." && sleep 90 && \
curl -s http://localhost:9000 > /dev/null && \
echo "‚úÖ SonarQube accessible sur http://localhost:9000" || \
echo "‚ùå Probl√®me, v√©rifiez: docker logs sonarqube"
